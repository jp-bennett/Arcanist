using ArcaneTide.Utils;
using ArcaneTide.Components;
using Kingmaker.Blueprints.Classes;
using Kingmaker.Blueprints.Classes.Selection;
using Kingmaker.Blueprints.Facts;
using Kingmaker.Localization;
using Kingmaker.UnitLogic.Abilities.Blueprints;
using Kingmaker.UnitLogic.ActivatableAbilities;
using Kingmaker.UnitLogic.Buffs.Blueprints;
using Kingmaker.UnitLogic.Commands.Base;
using Kingmaker.UnitLogic.FactLogic;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Kingmaker.UnitLogic.Abilities.Components;
using Kingmaker.Blueprints.Classes.Spells;
using Kingmaker.UnitLogic;
using Kingmaker.Blueprints;
using Kingmaker.ElementsSystem;
using Kingmaker.Designers.Mechanics.Facts;
using Kingmaker.Blueprints.Classes.Prerequisites;
using Kingmaker.UnitLogic.Mechanics.Actions;
using Kingmaker.UnitLogic.Mechanics;
using Kingmaker.Enums.Damage;
using Kingmaker.Enums;
using Kingmaker.UnitLogic.Mechanics.Components;
using Kingmaker.EntitySystem.Stats;

namespace ArcaneTide.Arcanist {
    static class ArcaneExploits {
        static public BlueprintFeature potentMagic,metaMixing,fastStudy,armoredMask,energyShield;
        static public BlueprintFeatureSelection familiar, metaKnowledge;
        static public BlueprintFeatureSelection exploitSelection;
        static public bool loaded = false;
        static public void Load() {
            
            potentMagic = PotentMagic.Create();
            metaMixing = Metamixing.Create();
            fastStudy = FastStudy.Create();
            familiar = Familiar.Create();
            armoredMask = ArmoredMask.Create();
            energyShield = EnergyShield.Create();
            metaKnowledge = MetamagicKnownledge.Create();
            SchoolUnderstanding.Test();
            List<BlueprintFeature> feats = new List<BlueprintFeature>();
            feats = (new BlueprintFeature[] { potentMagic, metaMixing,fastStudy,familiar,armoredMask,
                energyShield,metaKnowledge}).ToList<BlueprintFeature>();
            
            exploitSelection = Helpers.CreateFeatureSelection("ArcanistClassExploitFeatureSelection", "", "",
                "b9e8c9196f14ffb7d1d5b9b17bfa8bbe",
                IconSet.wizard_feat_selection,
                FeatureGroup.None);
            exploitSelection.SetName(Helpers.CreateString("ArcanistClass.Exploit.FeatureSelection.Name"));
            exploitSelection.SetDescription(Helpers.CreateString("ArcanistClass.Exploit.FeatureSelection.Desc"));
            exploitSelection.SetFeatures(feats);
            loaded = true;
        }
    }
    static class PotentMagic{
        static public BlueprintFeature exploit;
        static public BlueprintFeature Create() {
            BlueprintFeature feat = Helpers.CreateFeature("ArcanistClassExploitPM", "", "",
                "66cbd336c0cd2adbb8404567867d545f",//MD5-32[ArcanistClass.Exploit.PotentMagic]
                IconSet.spell_strike_icon,
                FeatureGroup.None);
            feat.SetName(Helpers.CreateString("ArcanistClass.Exploit.PotentMagic.Name"));
            feat.SetDescription(Helpers.CreateString("ArcanistClass.Exploit.PotentMagic.Desc"));
            exploit = feat;
            return feat;
        }

    }

    static class Metamixing {
        static public BlueprintFeature exploit;
        static public BlueprintBuff buff;
        static internal BlueprintActivatableAbility abl;
        static public BlueprintFeature Create() {
            LocalizedString name = Helpers.CreateString("ArcanistClass.Exploit.Metamixing.Name");
            LocalizedString desc = Helpers.CreateString("ArcanistClass.Exploit.Metamixing.Desc");
            buff = Helpers.CreateBuff("ArcanistClassExploitMetamixingOnBuff", "", "",
                "394cd08033b73c5159a745077c28f7e6", //MD5-32[ArcanistClass.Exploit.Metamixing.OnBuff]
                IconSet.spell_strike_icon, null);
            buff.SetName(name);
            buff.SetDescription(desc);

            abl = Helpers.CreateActivatableAbility("ArcanistClassExploitMetamixingActiAbl", "", "",
                "6f45e966f1b25e3fdf2d3005bdce1288",//MD5-32[ArcanistClass.Exploit.Metamixing.ActiAbl]
                IconSet.spell_strike_icon,
                buff,
                AbilityActivationType.Immediately,
                UnitCommand.CommandType.Free,
                null);
            abl.SetName(name);
            abl.SetDescription(desc);

            BlueprintFeature feat = Helpers.CreateFeature("ArcanistClassExploitPM", "", "",
                "e1a1e094774fa416fbc25ee3a8a87144",//MD5-32[ArcanistClass.Exploit.Metamixing]
                IconSet.spell_strike_icon,
                FeatureGroup.None,
                Helpers.Create<AddFacts>(a => a.Facts = new BlueprintUnitFact[] { abl }));
            feat.SetName(name);
            feat.SetDescription(desc);
            exploit = feat;
            return feat;
        }
    }

    static class FastStudy {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintAbility abl;
        static public BlueprintFeature exploit;
        static internal BlueprintBuff flagBuff;
        static internal Dictionary<SpellSchool, BlueprintAbility> schoolMasterAbls = new Dictionary<SpellSchool, BlueprintAbility>();
        static public BlueprintFeature Create() {
            LocalizedString loc_name = Helpers.CreateString("ArcanistClass.Exploit.FastStudy.Name");
            LocalizedString loc_desc = Helpers.CreateString("ArcanistClass.Exploit.FastStudy.Desc");
            flagBuff = Helpers.CreateBuff("ArcanistClassExploitFastStudyFlagBuff", "", "",
                OtherUtils.GetMd5("ArcanistClassExploitFastStudyFlagBuff"), null, null);
            flagBuff.SetBuffFlags(flagBuff.GetBuffFlags() | BuffFlags.HiddenInUi);

            FastStudyComponent comp = Helpers.Create<FastStudyComponent>();
            comp.flagBuff = flagBuff;
            AbilityResourceLogic comp_res = Helpers.Create<AbilityResourceLogic>();
            comp_res.RequiredResource = ArcaneReservoir.resource;
            comp_res.Amount = 1;
            comp_res.CostIsCustom = false;
            comp_res.IsSpendResource = true;
            AbilityRequirementBuff comp_req = Helpers.Create<AbilityRequirementBuff>();
            comp_req.buff = flagBuff;
            comp_req.Not = true;

            abl = Helpers.CreateAbility("ArcanistClassExploitFastStudyAbl", "", "",
                "da065b40cce4563648f5564c9c55aec5",//MD5-32[ArcanistClass.Exploit.FastStudy.Abl]
                IconSet.itembond_icon,
                AbilityType.Supernatural,
                UnitCommand.CommandType.Standard,
                AbilityRange.Personal,
                "", "",
                comp, comp_res);
            abl.SetName(loc_name);
            abl.SetDescription(loc_desc);
            abl.LocalizedDuration = PresetLocStrings.loc_instant;
            abl.LocalizedSavingThrow = PresetLocStrings.save_will_noharm;
            var fullRoundSetter = Helpers.CreateFieldSetter(typeof(BlueprintAbility), "m_IsFullRoundAction");
            fullRoundSetter(abl, true);
            exploit = Helpers.CreateFeature("ArcanistClassExploitFastStudyFeat", "", "",
                "ed15c20bdbbd5bc16a635e5339fe0c6a",//MD5-32[ArcanistClass.Exploit.FastStudy.Feat]
                IconSet.itembond_icon,
                FeatureGroup.None,
                Helpers.Create<AddFacts>(a => a.Facts = new BlueprintUnitFact[] { abl }));
            exploit.SetName(loc_name);
            exploit.SetDescription(loc_desc);

            CreateSchoolMasterAbls();
            return exploit;
        }
        static public void CreateSchoolMasterAbls() {
            foreach(SpellSchool sc in Enum.GetValues(typeof(SpellSchool))) {
                if (sc == SpellSchool.None) continue;
                string name = $"ArcanistClassExploitFastStudy{OtherUtils.GetSchoolStr(sc)}MasterAbl";
                BlueprintAbility abl = Helpers.CreateAbility(name, "", "",
                    OtherUtils.GetMd5(name),
                    IconSet.school_icons[sc],
                    AbilityType.Special,
                    UnitCommand.CommandType.Free,
                    AbilityRange.Personal,
                    "", "");
                abl.SetName(Helpers.CreateString($"ArcanistClass.Exploit.FastStudy.{OtherUtils.GetSchoolStr(sc)}MasterAbl.Name"));
                //abl.SetDescription(Helpers.CreateString($"ArcanistClass.Exploit.FastStudy.{OtherUtils.GetSchoolStr(sc)}MasterAbl.Desc"));
                abl.LocalizedDuration = PresetLocStrings.loc_instant;
                abl.LocalizedSavingThrow = PresetLocStrings.save_none;

                schoolMasterAbls[sc] = abl;
            }
            
        }
        static public void AddMasterAbls(UnitDescriptor unit) {
            foreach(var kv in schoolMasterAbls) {
                if(kv.Value.ComponentsArray.Length > 0)unit.AddFact(kv.Value);
            }
        }
        static public void RemoveMasterAbls(UnitDescriptor unit) {
            foreach(var kv in schoolMasterAbls) {
                if (unit.HasFact(kv.Value)) {
                    unit.RemoveFact(kv.Value);
                }
            }
        }

        static public void RefreshSubAbls(Spellbook spellbook, int spellLevel) {
            Dictionary<SpellSchool, List<BlueprintAbility>> allVariants = new Dictionary<SpellSchool, List<BlueprintAbility>>();
            List<BlueprintAbility> spellsAdded = new List<BlueprintAbility>();
            foreach (var kv in schoolMasterAbls) {
                var abl = kv.Value;
                abl.SetComponents(new BlueprintComponent[] { });
                allVariants[kv.Key] = new List<BlueprintAbility>();
            }
            
            foreach (var spell in spellbook.GetKnownSpells(spellLevel)) {
                SpellSchool sc = spell.Blueprint.School;
                if (sc == SpellSchool.None) continue;

                FastStudyMemorizeAction actn = Helpers.Create<FastStudyMemorizeAction>();
                actn.spell = spell;
                actn.spellbook = spellbook;
                AbilityEffectRunAction comp = Helpers.Create<AbilityEffectRunAction>();
                comp.Actions = new ActionList {
                    Actions = new GameAction[] { actn }
                };
              
                string abl_i_name = $"ArcanistClassExploitFastStudy_Spell{spell.Blueprint.AssetGuid}_{(spell.MetamagicData==null?0:spell.MetamagicData.MetamagicMask)}";
                BlueprintAbility abl_i;
                if (library.BlueprintsByAssetId.ContainsKey(OtherUtils.GetMd5(abl_i_name))) {
                    abl_i = library.Get<BlueprintAbility>(OtherUtils.GetMd5(abl_i_name));
                }
                else {
                    abl_i = Helpers.CreateAbility(abl_i_name, "", "",
                        OtherUtils.GetMd5(abl_i_name), spell.Blueprint.Icon,
                        AbilityType.Extraordinary,
                        UnitCommand.CommandType.Free,
                        AbilityRange.Personal,
                        "", "", comp);
                }
                abl_i.SetName(spell.Blueprint.Name);
                abl_i.SetDescription(spell.Blueprint.Description);
                abl_i.LocalizedDuration = spell.Blueprint.LocalizedDuration;
                abl_i.LocalizedSavingThrow = spell.Blueprint.LocalizedSavingThrow;
                allVariants[sc].Add(abl_i);
            }

            foreach(var kv in schoolMasterAbls) {
                var abl = kv.Value;
                SpellSchool sc = kv.Key;
                if (allVariants[sc].Count > 0) {
                    abl.AddComponent(abl.CreateAbilityVariants(allVariants[sc]));
                }
            }
        }
    }
    static class SchoolUnderstanding {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintAbility abl;
        static public BlueprintFeature exploit;
        static public BlueprintFeature Test() {
            var feat = library.CopyAndAdd<BlueprintFeature>(
                "e015d05ca18b5c24183cd062486fd46b",
                "TestTekelis970309",
                OtherUtils.GetMd5("TestTekelis970309")
                );
            var ori_abl = library.Get<BlueprintAbility>("810992c76efdde84db707a0444cf9a1c");
            feat.AddComponent(Helpers.Create<AddClassLevelToRankBonus>(a => {
                a.Spell = ori_abl;
                a.Class = ArcanistClass.arcanist;
                a.Bonus = 1;
                a.MultiplierClassLevel = 1;
            }));
            return feat;
        }
    }

    static class Familiar {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintFeatureSelection arcaneBondSelection = library.Get<BlueprintFeatureSelection>("03a1781486ba98043afddaabf6b7d8ff");
        static public BlueprintFeatureSelection exploit;
        static public BlueprintFeatureSelection Create() {
            if (library.BlueprintsByAssetId.ContainsKey("3bd212428da37fa1f50a9bece6da688f")) {
                return library.Get<BlueprintFeatureSelection>("3bd212428da37fa1f50a9bece6da688f");
            }
            BlueprintFeature itemBondFeat = library.Get<BlueprintFeature>("2fb5e65bd57caa943b45ee32d825e9b9");
            exploit = Helpers.CreateFeatureSelection("ArcanistClassExploitFamiliarFeatSelection", "", "",
                "3bd212428da37fa1f50a9bece6da688f",
                IconSet.familiar_pet,
                FeatureGroup.None,
                Helpers.Create<PrerequisiteNoFeature>(a => a.Feature = arcaneBondSelection));
            
            exploit.SetName(Helpers.CreateString("ArcanistClass.Exploit.Familiar.FeatSelection.Name"));
            exploit.SetDescription(Helpers.CreateString("ArcanistClass.Exploit.Familiar.FeatSelection.Desc"));
            var choices = new List<BlueprintFeature>();
            foreach(var subfeat in arcaneBondSelection.AllFeatures) {
                if(subfeat != itemBondFeat) {
                    choices.Add(subfeat);
                }
            }
            exploit.SetFeatures(choices);
            

            //exploit.AddComponent(Helpers.Create<PrerequisiteNoFeature>(a => a.Feature = arcaneBondSelection));
            return exploit;
        }
    }
    
    static class ArmoredMask {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintCharacterClass arcanist => ArcanistClass.arcanist;
        static public BlueprintFeature exploit;
        static public ContextActionCastSpell CreateAction(BlueprintAbility spell) {
            var actn = Helpers.Create<ContextActionCastSpell>();
            actn.Spell = spell;
            return actn;
        }
        static public BlueprintFeature Create() {
            if (library.BlueprintsByAssetId.ContainsKey("e29cbe5f70f646956aaf3e3456fd0525")) {
                return library.Get<BlueprintFeature>("e29cbe5f70f646956aaf3e3456fd0525");
            }
            BlueprintAbility MageArmor = library.Get<BlueprintAbility>("9e1ad5d6f87d19e4d8883d63a6e35568");
            BlueprintAbility ShieldOfFaith = library.Get<BlueprintAbility>("183d5bb91dea3a1489a6db6c9cb64445");

            BlueprintAbility MageArmorNeu = library.CopyAndAdd<BlueprintAbility>(
                MageArmor,
                "ArcanistClassExploitArmoredMaskMageArmorNeu",
                OtherUtils.GetMd5("ArcanistClassExploitArmoredMaskMageArmorNeu"));

            var ablShieldFaith = Helpers.CreateAbility("ArcanistClassExploitArmoredMaskSOFAbl", "", "",
                "57481ddad8630cc6bec978034c758b3c",//MD5-32[ArcanistClass.Exploit.ArmoredMask.SOFAbl]
                ShieldOfFaith.Icon,
                AbilityType.Supernatural,
                UnitCommand.CommandType.Free,
                AbilityRange.Personal,
                "", "",
                Helpers.Create<ReplaceCasterLevelOfAbility>(a => {
                    a.Class = arcanist;
                    a.Spell = ShieldOfFaith;
                }),
                Helpers.Create<AbilityEffectRunAction>(a => {
                    a.Actions = new ActionList {
                        Actions = new GameAction[] { CreateAction(ShieldOfFaith) }
                    };
                }),
                Helpers.Create<AbilityResourceLogic>(a => {
                    a.RequiredResource = ArcaneReservoir.resource;
                    a.Amount = 1;
                    a.CostIsCustom = false;
                    a.IsSpendResource = true;
                }));
            ablShieldFaith.SetName(ShieldOfFaith.GetName());
            ablShieldFaith.SetDescription(ShieldOfFaith.GetDescription());
            ablShieldFaith.LocalizedDuration = ShieldOfFaith.LocalizedDuration;
            ablShieldFaith.LocalizedSavingThrow = ShieldOfFaith.LocalizedSavingThrow;

            BuffAddFacts buffcomp = Helpers.Create<BuffAddFacts>();
            buffcomp.Facts = new BlueprintUnitFact[] { ablShieldFaith };
            BlueprintBuff buff = Helpers.CreateBuff("ArcanistClassExploitShieldMaskHiddenBuff", "fart", "fuck",
                OtherUtils.GetMd5("ArcanistClassExploitShieldMaskHiddenBuff"),
                IconSet.vanish_icon, null, buffcomp);
            buff.SetBuffFlags(buff.GetBuffFlags() | BuffFlags.HiddenInUi);
            buff.SetBuffFlags(buff.GetBuffFlags() & (~BuffFlags.IsFromSpell));

            MageArmorNeu.Range = AbilityRange.Personal;
            var addBuffActn = Helpers.Create<ContextActionApplyBuff>(a => {
                a.Buff = buff;
                a.UseDurationSeconds = false;
                a.Permanent = false;
                a.IsNotDispelable = true;
                a.IsFromSpell = false;
                a.DurationValue = new ContextDurationValue {
                    Rate = DurationRate.Hours,
                    DiceType = Kingmaker.RuleSystem.DiceType.Zero,
                    DiceCountValue = new ContextValue {
                        ValueType = ContextValueType.Simple,
                        Value = 0
                    },
                    BonusValue = new ContextValue {
                        ValueType = ContextValueType.Rank,
                        ValueRank = Kingmaker.Enums.AbilityRankType.Default
                    }
                };
            });
            /*MageArmorNeu.AddComponent(Helpers.Create<AbilityEffectRunAction>(a => {
                a.Actions = new ActionList {
                    Actions = new GameAction[] { addBuffActn }
                };
            }));*/
            

            var ablMageArmor = Helpers.CreateAbility("ArcanistClassExploitArmoredMaskMAAbl", "", "",
                "e9c4364ae06f7323a7d53264a2202907",//MD5-32[ArcanistClass.Exploit.ArmoredMask.MAAbl]
                MageArmor.Icon,
                AbilityType.Supernatural,
                UnitCommand.CommandType.Standard,
                AbilityRange.Personal,
                "", "",
                Helpers.Create<ReplaceCasterLevelOfAbility>(a => {
                    a.Class = arcanist;
                    a.Spell = MageArmorNeu;
                }),
                Helpers.Create<AbilityEffectRunAction>(a => {
                    a.Actions = new ActionList {
                        Actions = new GameAction[] { CreateAction(MageArmorNeu), addBuffActn }
                    };
                }),
                Helpers.Create<AbilityResourceLogic>(a => {
                    a.RequiredResource = ArcaneReservoir.resource;
                    a.Amount = 1;
                    a.CostIsCustom = false;
                    a.IsSpendResource = true;
                }));
            ablMageArmor.SetName(Helpers.CreateString("ArcanistClass.Exploit.ArmoredMask.MAAbl.Name"));
            ablMageArmor.SetDescription(Helpers.CreateString("ArcanistClass.Exploit.ArmoredMask.MAAbl.Desc"));
            ablMageArmor.LocalizedDuration = Helpers.CreateString("ArcaneTide.HoursPerLevel");
            ablMageArmor.LocalizedSavingThrow = MageArmor.LocalizedSavingThrow;

            exploit = Helpers.CreateFeature("ArcanistClassExploitArmoredMaskFeat", "", "",
                "e29cbe5f70f646956aaf3e3456fd0525",//MD5-32[ArcanistClass.Exploit.ArmoredMask.Feat]
                MageArmor.Icon,
                FeatureGroup.None,
                Helpers.Create<AddFacts>(a => a.Facts = new BlueprintUnitFact[] { ablMageArmor }),
                Helpers.Create<ReplaceCasterLevelOfAbility>(a => {
                    a.Class = arcanist;
                    a.Spell = ablMageArmor;
                }));
            exploit.SetName(ablMageArmor.GetName());
            exploit.SetDescription(ablMageArmor.GetDescription());
            return exploit;
        }
    }
    static class MetamagicKnownledge {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintCharacterClass arcanist => ArcanistClass.arcanist;
        static public BlueprintFeatureSelection exploit;
        static public BlueprintFeatureSelection Create() {
            if (library.BlueprintsByAssetId.ContainsKey("0d8b199008f557bf50cdd7b9f4b0920c")) {
                return library.Get<BlueprintFeatureSelection>("0d8b199008f557bf50cdd7b9f4b0920c");
            }
            exploit = Helpers.CreateFeatureSelection("ArcanistClassExploitMetamagicKnowledge", "", "",
                "0d8b199008f557bf50cdd7b9f4b0920c",//MD5-32[ArcanistClass.Exploit.MetamagicKnowledge]
                IconSet.metamagic,
                FeatureGroup.None);
            List<BlueprintFeature> metafeatList = new List<BlueprintFeature>();
            foreach(var kv in MetaFeats.dict) {
                metafeatList.Add(library.Get<BlueprintFeature>(kv.Value));
            }
            exploit.SetName(Helpers.CreateString("ArcanistClass.Exploit.MetamagicKnowledge.Name"));
            exploit.SetDescription(Helpers.CreateString("ArcanistClass.Exploit.MetamagicKnowledge.Desc"));
            exploit.SetFeatures(metafeatList);
            return exploit;
        }
    }
    static class EnergyShield {
        static internal LibraryScriptableObject library => Main.library;
        static internal BlueprintCharacterClass arcanist => ArcanistClass.arcanist;
        static public BlueprintFeature exploit;
        static internal Dictionary<DamageEnergyType, BlueprintAbility> resist_energy_spells = new Dictionary<DamageEnergyType, BlueprintAbility>();
        static public BlueprintFeature Create() {
            if (library.BlueprintsByAssetId.ContainsKey("03708743f0b26e55c80b9c7386bb1a57")) {
                return library.Get<BlueprintFeature>("03708743f0b26e55c80b9c7386bb1a57");
            }
            resist_energy_spells[DamageEnergyType.Fire] = library.Get<BlueprintAbility>("ddfb4ac970225f34dbff98a10a4a8844");
            resist_energy_spells[DamageEnergyType.Cold] = library.Get<BlueprintAbility>("5368cecec375e1845ae07f48cdc09dd1");
            resist_energy_spells[DamageEnergyType.Acid] = library.Get<BlueprintAbility>("fedc77de9b7aad54ebcc43b4daf8decd");
            resist_energy_spells[DamageEnergyType.Electricity] = library.Get<BlueprintAbility>("90987584f54ab7a459c56c2d2f22cee2");
            resist_energy_spells[DamageEnergyType.Sonic] = library.Get<BlueprintAbility>("8d3b10f92387c84429ced317b06ad001");
            List<BlueprintAbility> variants = new List<BlueprintAbility>();
            LocalizedString name = Helpers.CreateString("ArcanistClass.Exploit.EnergyShield.Name");
            LocalizedString desc = Helpers.CreateString("ArcanistClass.Exploit.EnergyShield.Desc"); 
            foreach(DamageEnergyType energy in typeof(DamageEnergyType).GetEnumValues()) {
                if ((int)(energy) >= 5) continue;//energy must be five kinds of elements (0-4)
                AddDamageResistanceEnergy comp1 = Helpers.Create<AddDamageResistanceEnergy>();
                comp1.UseValueMultiplier = true;
                comp1.ValueMultiplier = 5;
                comp1.Type = energy;
                comp1.Value = new ContextValue {
                    ValueRank = AbilityRankType.DamageBonus,
                    ValueType = ContextValueType.Rank
                };

                ContextRankConfig comp2 = Helpers.CreateContextRankConfig(
                    ContextRankBaseValueType.ClassLevel,
                    ContextRankProgression.StartPlusDivStep,
                    AbilityRankType.DamageBonus,
                    2, 6, -5, 5, false, StatType.Unknown, null,
                    new BlueprintCharacterClass[] { arcanist }, null,
                    null, null, null);

                string buffname_i = $"ArcanistClassExploitEnergyShield{energy.ToString()}Buff";
                BlueprintBuff buff_i = Helpers.CreateBuff(buffname_i, "", "",
                    OtherUtils.GetMd5(buffname_i),
                    resist_energy_spells[energy].Icon, null,comp1,comp2);
                buff_i.SetName(Helpers.CreateString($"ArcanistClass.Exploit.EnergyShield.{energy.ToString()}Buff.Name"));
                buff_i.SetDescription(Helpers.CreateString($"ArcanistClass.Exploit.EnergyShield.{energy.ToString()}Buff.Desc"));

                var actn_i = Helpers.Create<ContextActionApplyBuff>();
                actn_i.Buff = buff_i;
                actn_i.UseDurationSeconds = false;
                actn_i.Permanent = false;
                actn_i.IsFromSpell = false;
                actn_i.IsNotDispelable = true;
                actn_i.DurationValue = new ContextDurationValue {
                    Rate = DurationRate.Minutes,
                    DiceCountValue = new ContextValue(),
                    BonusValue = new ContextValue {
                        ValueType = ContextValueType.Rank,
                        ValueRank = AbilityRankType.Default
                    },
                    DiceType = Kingmaker.RuleSystem.DiceType.Zero
                };

                var rankconfig_abl = Helpers.CreateContextRankConfig(ContextRankBaseValueType.ClassLevel,
                    ContextRankProgression.AsIs, AbilityRankType.Default, 1, 20, 0,0,
                    false,StatType.Unknown,null,new BlueprintCharacterClass[] { arcanist });

                string abli_name = $"ArcanistClassExploitEnergyShield{energy.ToString()}SubAbl";
                BlueprintAbility abl_i = Helpers.CreateAbility(abli_name, "", "",
                    OtherUtils.GetMd5(abli_name),
                    resist_energy_spells[energy].Icon,
                    AbilityType.Supernatural,
                    UnitCommand.CommandType.Standard,
                    AbilityRange.Personal,
                    "", "",
                    Helpers.Create<AbilityResourceLogic>(a => {
                        a.RequiredResource = ArcaneReservoir.resource;
                        a.Amount = 1;
                        a.CostIsCustom = false;
                        a.IsSpendResource = true;
                    }),
                    Helpers.Create<AbilityEffectRunAction>(a => a.Actions = new ActionList {
                        Actions = new GameAction[] {actn_i}
                    }),
                    rankconfig_abl);//here we need to add the buff & the resource comp
                abl_i.SetName(Helpers.CreateString($"ArcanistClass.Exploit.EnergyShield.{energy.ToString()}Buff.Name"));
                abl_i.SetDescription(Helpers.CreateString($"ArcanistClass.Exploit.EnergyShield.{energy.ToString()}Buff.Desc"));
                abl_i.LocalizedDuration = PresetLocStrings.loc_minute;
                abl_i.LocalizedSavingThrow = PresetLocStrings.save_will_noharm;
                variants.Add(abl_i);
            }
            BlueprintAbility abl = Helpers.CreateAbility("ArcanistClassExploitEnergyShieldAbl", "", "",
                "f606d49df053805db41da7c7f50e697a",//MD5-32[ArcanistClass.Exploit.EnergyShield.Abl]
                IconSet.resistenergy,
                AbilityType.Supernatural,
                UnitCommand.CommandType.Standard,
                AbilityRange.Personal,
                "", "",
                Helpers.Create<AbilityResourceLogic>(a => {
                    a.RequiredResource = ArcaneReservoir.resource;
                    a.Amount = 1;
                    a.CostIsCustom = false;
                    a.IsSpendResource = true;
                }));
            abl.SetName(name);
            abl.SetDescription(desc);
            abl.LocalizedDuration = PresetLocStrings.loc_minute;
            abl.LocalizedSavingThrow = PresetLocStrings.save_will_noharm;
            abl.AddComponent(abl.CreateAbilityVariants(variants));

            exploit = Helpers.CreateFeature("ArcanistClassExploitEnergyShieldFeat", "", "",
                "03708743f0b26e55c80b9c7386bb1a57",//MD5-32[ArcanistClass.Exploit.EnergyShield.Feat]
                IconSet.resistenergy,
                FeatureGroup.None,
                Helpers.Create<AddFacts>(a => a.Facts = new BlueprintUnitFact[] { abl }));
            exploit.SetName(name);
            exploit.SetDescription(desc);
            return exploit;
        }
    }
    static class SwiftConsume {

    }
    static class AcidJet {
        
    }
}
